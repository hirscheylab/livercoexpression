---
title: "R Notebook for liver coexpression analysis"
output: html_notebook
---

#load libraries

```{r}
library(ggraph)
library(enrichplot)
library(clusterProfiler)
library(tidyverse)
library(tibble)
library(readr)
library(janitor)
library("annotate")
library("hgu133a2.db")
library(beepr)


#clear environment
rm(list=ls()) 

#print Session information for provenance and reproducibility
utils:::print.sessionInfo(sessionInfo()[-7]) 
#You can remove an item from sessionInfo(), which is a list with a class attribute, by printing the resulting object omitting one of the list items (omitted list of packages installed, but not loaded)

#Set theme
theme_set(theme_light())
```

#import data
```{r}
# Load original liver data
liver_data <- read_tsv('data/GSE14520_data.txt') %>% 
  clean_names() %>%
  rename_all(funs(str_remove(., "^x")))

# Get all liver sample IDs and descriptions from a text file that is copy/pasted 
# from https://www.ncbi.nlm.nih.gov/geo/query/acc.cgi?acc=GSE14520
liver_IDs <- read_tsv('data/GSE14520_ID.txt', col_names = FALSE)
names(liver_IDs) = c('gsm_id', 'description')
liver_IDs$gsm_id = gsub(' ', '', liver_IDs$gsm_id) # remove white space from GSE IDs

# Add Tumor/Non-Tumor status column to liver ID table 
liver_IDs <- liver_IDs %>% 
  mutate(status = if_else(grepl("Non-Tumor", description) | grepl("six healthy donors", description), 'Non-Tumor', 'Tumor'))
liver_IDs$status <- as.factor(liver_IDs$status)

#Join liver data with ID to append tumor status
liver_data <- liver_data %>% 
  left_join(liver_IDs, by = "gsm_id")
```

#select data of interest
```{r}
#get dataset of interest (non-tumor data)
data <- liver_data %>% 
  filter(status == "Non-Tumor") %>% 
  select_if(is.numeric)

```

#correlation analysis
```{r}
# Create SIRT5 correlation array using Spearman correlation
probe_cor <- c("219185_at")
SIRT5cor <- cor(data, data[probe_cor], method = "spearman")

# Correlation array data formatting, get gene symbol, entrezid, and gene name for each probe
SIRT5cor <- cbind(dimnames(SIRT5cor)[[1]], SIRT5cor)
SIRT5cor <- as_tibble(SIRT5cor)
names(SIRT5cor)[1] <- 'PROBEID'
probes <- SIRT5cor$PROBEID
map <- select(hgu133a2.db, probes, c("SYMBOL","ENTREZID", "GENENAME"))
SIRT5cor = left_join(SIRT5cor, map, "PROBEID")
names(SIRT5cor)[2] <- "SIRT5"
SIRT5cor$SIRT5 <- as.numeric(SIRT5cor$SIRT5)
SIRT5cor <- SIRT5cor %>% dplyr::select(ENTREZID, SIRT5)
```

#save correlation data
```{r}
save(SIRT5cor, file = "data/SIRT5cor_nontumor.Rda")
```


#import correlation data
```{r}
load("data/SIRT5cor_nontumor.RDA") #load the nontumor data frame
```


#GSEA
```{r}
#prep dataframe for gsea


#Copying over the dataframe
geneList <- SIRT5cor

#Creating the correct data struture for input, a named vector of correlation values for analysis. Ensured to be sorted in 
#decreasing order
genes <- geneList[["SIRT5"]] #Select SIRT5 Coorelation values 
names(genes) <- (geneList[["ENTREZID"]]) #Encoding the EntrezID in its position as an attribute of a numeric vector
genes <- sort(genes , decreasing = TRUE) #Sort in decreasing order


keggResult <- gseKEGG(genes , organism = "hsa", keyType = "ncbi-geneid") #Conduct gene set analysis using KEGG database
keggX <- setReadable(keggResult, 'org.Hs.eg.db', keyType = 'ENTREZID') #Convert the EntrezID to actual gene names

results <- keggX@result #Isolate out the results data frame
resultsGeneSets <- keggX@geneSets #Isolate out the gene sets themselves


```
#Visualization
```{r}

p1 <- dotplot(keggX,showCategory = 30, x = 'GeneRatio' , color = "pvalue", font.size = 12) + ggtitle("dotplot for SIRT5cor_all Data") #Creates a dotplot using the 30 processes with the lowest pvalues
plot_grid(p1, ncol=1)

cnetplot(keggX, foldChange=genes, node_label = FALSE)#Creates a network using the 5 processes with the lowest pvalues. The processes are central nodes that are connected to the genes that are in its respective gene set

emapplot(keggX , showCategory = 30 , color = "pvalue")#Creates a network using the 30 processes with the lowest pvalues. The processes are nodes that are connected to other processes that share the same genes within its gene set. 

```
#Visualization
```{r}

p1 <- dotplot(keggX, showCategory = 30, x = 'GeneRatio' , color = "pvalue", font.size = 12) + ggtitle("dotplot for SIRT5cor_all Data") #Creates a dotplot using the 30 processes with the lowest pvalues
plot_grid(p1, ncol=1)

cnetplot(keggX, foldChange=genes)#Creates a network using the 5 processes with the lowest pvalues. The processes are central nodes that are connected to the genes that are in its respective gene set

emapplot(keggX , showCategory = 30 , color = "pvalue")#Creates a network using the 30 processes with the lowest pvalues. The processes are nodes that are connected to other processes that share the same genes within its gene set. 

beep(sound = 8) #because mario is awesome
```

#volcano plot
```{r}
#make labels df
sig <- mac_plot %>% 
  filter(normalized_control <= -1 | normalized_control >= 1) %>% 
  filter(p.value < 0.05)

#plot relative log2 fold change vs. p.value
ggplot(mac_plot) +
  geom_hline(aes(yintercept = 1.30103), linetype = "dotted") + #FDR p.value 0.05
  geom_vline(aes(xintercept = 1), linetype = "dotted") + #2FC
  geom_vline(aes(xintercept = -1), linetype = "dotted") + #-2FC
  geom_vline(aes(xintercept = 0)) + #bold axis
  geom_hline(aes(yintercept = 0)) + #bold axis
  geom_point(aes(x = normalized_control, y = -log(p.value, 10), fill = normalized_control), alpha = 0.8, size = 4, shape = 21, color = "black") +
  geom_label_repel(data = sig, aes(x = normalized_control, y = -log(p.value, 10), label = metabolite), alpha = 0.8, size = 3, segment.size = 0.3, point.padding = 0.8) +
  scale_fill_viridis(option = "viridis", direction = 1, name = expression("Log"[2]*"FC")) +
  labs(x = expression("Relative fold change (log"[2]*") compared to control"), 
       y = expression("-Log "[10]*" uncorrected p-value"), 
       title = "Metabolite profiling from Unstimulated wild-type and SIRTKO mouse BMDM",
       subtitle = "The role of SIRT4 at baseline") +
  theme_bw() + 
  theme(
    plot.title = element_text(face = "bold", size = 12),
    legend.background = element_rect(fill = "white", size = 4, colour = "white"),
    axis.ticks = element_line(colour = "grey70", size = 0.2),
    panel.grid.major = element_line(colour = "grey70", size = 0.2),
    panel.grid.minor = element_blank()
  ) 

```
#save
```{r}
ggsave("output/livercorr.pdf", plot = last_plot(), device = "pdf", height = 6, width = 8, units = "in", dpi = 600)
```

